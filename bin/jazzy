#!/usr/bin/env ruby
require 'jazzy'
require 'find'
require 'fileutils'
require 'optparse'

options = {
  input: File.expand_path('.'),
  output: File.expand_path('docs'),
  xcodebuild_arguments: [],
  excludes: []
}

opt_parser = OptionParser.new do |opt|
  opt.banner = "Usage: jazzy [-i input] [-o output]"
  opt.separator  ""
  opt.separator  "Options"

  opt.on("-o", "--output FOLDER", "Folder to output the HTML docs to") do |output|
    options[:output] = File.expand_path(output)
  end

  opt.on("-e", "--exclude filepath1,filepath2,…filepathN", Array, "Exclude specific files") do |e|
    options[:excludes] = e
  end

  opt.on("-c", "--[no-]clean", "Delete contents of output directory before running") do |clean|
    options[:clean] = clean
  end

  opt.on("-x", "--xcodebuild-arguments arg1,arg2,…argN", Array, "Arguments to forward to xcodebuild") do |args|
    options[:xcodebuild_arguments] = args
  end

  opt.on("-s", "--sourcekitten-sourcefile FILEPATH", "XML doc file generated from sourcekitten to parse") do |s|
    options[:sourcekitten_sourcefile] = s
  end

  opt.on("-v", "--version", "Print version number") do
    puts "jazzy version: " + Jazzy::VERSION
    exit
  end

  opt.on("-h", "--help", "help") do
    puts opt_parser
    exit
  end
end

opt_parser.parse!

def prepare_output_dir(output_dir, clean)
  FileUtils.rm_r output_dir if (clean && File.directory?(output_dir))
  FileUtils.mkdir_p output_dir
end

if options[:sourcekitten_sourcefile]
  file = File.open(options[:sourcekitten_sourcefile])
  fileContents = file.read
  file.close
  prepare_output_dir(options[:output], options[:clean])
  Jazzy::DocBuilder.buildDocsForSourceKittenOutput(fileContents, options[:output])
  exit
end

sourcekittenOutput = Jazzy::SourceKitten.runSourceKitten(options[:xcodebuild_arguments])
sourcekittenExitCode = $?.exitstatus
if sourcekittenExitCode == 0
  prepare_output_dir(options[:output], options[:clean])
  Jazzy::DocBuilder.buildDocsForSourceKittenOutput(sourcekittenOutput, options[:output])
else
  puts sourcekittenOutput
  exit sourcekittenExitCode
end
